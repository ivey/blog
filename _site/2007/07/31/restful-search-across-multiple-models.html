<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>RESTful search across multiple models</title>
   <meta name="author" content="Michael D. Ivey" />
   <link rel="alternate" type="application/rss+xml" title="Everything" href="feed://everything.gweezlebur.com/rss" />
   <link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/gweezlebur" />

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />

   <link rel="openid.server"
         href="http://www.myopenid.com/server" />
   <link rel="openid.delegate"
         href="http://ivey.myopenid.com/" />
   <link rel="openid2.local_id"
         href="http://ivey.myopenid.com" />
   <link rel="openid2.provider"
         href="http://www.myopenid.com/server" />
   <meta http-equiv="X-XRDS-Location"
         content="http://www.myopenid.com/xrds?username=ivey.myopenid.com" />
   <!--
      <link rel="openid.server" href="https://pip.verisignlabs.com/server" />
      <link rel="openid.delegate" href="http://ivey.pip.verisignlabs.com/" />
      /-->

   <style type='text/css'>
     @import url('http://assets.skribit.com/stylesheets/SkribitSuggest.css');
   </style>
   <script src='http://assets.skribit.com/javascripts/SkribitSuggest.js' type='text/javascript'>
   </script>
   <script type="text/javascript" charset="utf-8">
     SkribitSuggest.suggest('http://skribit.com/lightbox/gweezlebur');
   </script>

</head>
<body>
<div id="container">
  <div id="header">
  <h1><a href="/">gweezlebur<span class="large-dot">.</span>com</a></h1>
  <h2>Michael Ivey, blogging since '99</h2>
  </div>
  
  <ul id="feeds">
    <li><a href="/">Home</a></li>
    <li><a href="http://everything.gweezlebur.com">Everything</a></li>
    <li><a href="/contact">Contact</a></li>
<!--    <li><a href="/pages">Pages</a></li>
    <li><a href="/files">Files</a></li> /-->
    <li><a href="/archive.html">Archive</a></li>
    <li><a href="http://divvs.com">Divvs</a></li>
    <li><a href="http://twitpay.me">Twitpay</a></li>
    <li><a href="http://iveyandbrown.com">Consulting</a></li>
  </ul>

  <div id="content">
    <div class="hentry" id="article-/2007/07/31/restful-search-across-multiple-models">
  <h2>
    <abbr class="published" title="{{ page.date | date: '%Y-%m-%dT%H:%M:%
S+00:00' }}">Tuesday, July 31, 2007</abbr>
  </h2>
  <div class="post blog">
  <h1 class="entry-title"><a href="/2007/07/31/restful-search-across-multiple-models.html">RESTful search across multiple models</a></h1>
  <div class="entry-content">
    <p>A guy I know from the Rails mailing list called me this morning.  He&#8217;s working on some kind of forum application, I think, and is thinking hard about how to do search in a RESTful way.</p>


	<p>Normally, I just use the index action to search across a single resource, but in his case he wants to search Posts, which are nested inside Topics, which are nested inside Forums.</p>


<div>
  <pre>
    <code class='ruby'># routes.rb

map.resources :forums do |forum|
  forum.resources :topics do |topic|
    topic.resources :posts
  end
end</code>
  </pre>
</div>

	<p>He wants to search Posts across all Forums and Topics.  One option would be to make PostsController serve double-duty</p>


<div>
  <pre>
    <code class='ruby'># routes.rb

map.resources :forums do |forum|
  forum.resources :topics do |topic|
    topic.resources :posts
  end
end

map.resources :posts</code>
  </pre>
</div>

	<p>and make it figure out whether or not it&#8217;s called in a scoped way or an unscoped way.</p>


<div>
  <pre>
    <code class='ruby'># posts_controller

def index
  if params.include?(:forum_id)
    # act normal, we're scoped
  else
    # we're special and top-level, so ... do something different
  end
end</code>
  </pre>
</div>

	<p>In this case, I suggested he go a different way.  Even though he says he only wants to search Posts, I feel pretty sure he wants to search Topics (by title) and Forums (by name), too.</p>


	<p>And even if he doesn&#8217;t, I do.  I&#8217;m about to add a general-purpose, cross-resource search to <span class="caps">SOLIS</span>, the registration and conference management system I&#8217;m writing for <a href="http://www.suusi.org"><span class="caps">SUUSI</span></a> and this seemed like an ideal way to help out a friend, make a much-needed blog post, and get some code done in the meantime.</p>


	<p>Before we get started, though&#8230;this is <strong>one way</strong> to do RESTful search.  It&#8217;s not the only way.  It is probably not the best way.  I&#8217;m not sure it&#8217;s a good way, since I just thought of it on the porch this morning and haven&#8217;t used it yet.  I&#8217;m pretty sure it&#8217;s an OK way, though, and a good place to start thinking about it. <span class="caps">YMMV</span>.</p>


	<p>OK, that&#8217;s out of the way.</p>


	<p>I already know what I want: a singleton resource called /search.  So let&#8217;s add it to the routes</p>


<div>
  <pre>
    <code class='ruby'>map.resource :search</code>
  </pre>
</div>

	<p>I can never remember whether singleton resources want singular (SearchController) or plural (SearchesController) names.  I&#8217;m pretty sure this has changed in edge, and possibly changed back.  So, I add the resource and load it up, and see what Rails tells me.  When I load /search, I get &#8216;uninitialized constant SearchController&#8217;.  Cool, it did what I wanted, and used singular.  (I just checked, and on edge it uses plural.  Bleh.  I guess I can see why, but&#8230;anyway.)  Now we need that controller.</p>


<div>
  <pre>
    <code class='text'>$ script/generate controller -c Search
      exists  app/controllers/
      exists  app/helpers/
      create  app/views/search
A         app/views/search
      exists  test/functional/
      create  app/controllers/search_controller.rb
A         app/controllers/search_controller.rb
      create  test/functional/search_controller_test.rb
A         test/functional/search_controller_test.rb
      create  app/helpers/search_helper.rb
A         app/helpers/search_helper.rb</code>
  </pre>
</div>

	<p>Because it&#8217;s a singleton resource, the actions are different; requesting /search calls the show action.</p>


	<p>Now, showing a search with no query string doesn&#8217;t make sense.  /search/new is an ugly <span class="caps">URL</span>.  I want to search as a <span class="caps">GET</span> not a <span class="caps">POST</span>, so you can bookmark it.  So, here&#8217;s what I ended up with.</p>


<div>
  <pre>
    <code class='ruby'># SearchController
  def show
    if params.include?(:q)
      # we have a query, so call create to actually do the search
      # don't redirect, though, there's no need, and bookmarkable
      # search URLs are handy
      create
      render :action =&amp;gt; &amp;quot;create&amp;quot;
    else
      # we don't have a query, so do the new action
      new
      render :action =&amp;gt; &amp;quot;new&amp;quot;
    end
  end

  def create
    @search_results = returning [] do |results|
      results &amp;lt;&amp;lt; Person.search(params[:q])
      results &amp;lt;&amp;lt; Event.search(params[:q])
      # ... add other models here, or use whatever searching you need
    end.flatten
  end</code>
  </pre>
</div>

<div>
  <pre>
    <code class='rhtml'># new.rhtml
&amp;lt;h1&amp;gt;Search for stuff (events, workshops, trips, people...)&amp;lt;/h1&amp;gt;
&amp;lt;% form_tag search_path, :method =&amp;gt; :get do %&amp;gt;
  &amp;lt;%= text_field_tag :q %&amp;gt;
  &amp;lt;%= submit_tag &amp;quot;Search&amp;quot;, :name =&amp;gt; nil  %&amp;gt;
&amp;lt;% end %&amp;gt;

# create.rhtml
&amp;lt;% @search_results.each do |result| %&amp;gt;
  &amp;lt;p&amp;gt;&amp;lt;%= result %&amp;gt;&amp;lt;/p&amp;gt;
&amp;lt;% end %&amp;gt;</code>
  </pre>
</div>

	<p>Obviously you&#8217;ll format your search results more prettily, with links and such.  And you&#8217;ll need search() methods on all the classes you&#8217;re going to search.  Or, make a Searcher model and let it do all the work.</p>
  </div>
</div>
 
<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>10 Nov 2008</span> &raquo; <a href="/2008/11/10/twitpay-an-atlanta-startup-weekend-2-company.html">Twitpay: An Atlanta Startup Weekend 2 Company</a></li>
    
      <li><span>27 Oct 2008</span> &raquo; <a href="/2008/10/27/find-the-princess-in-your-editor.html">Find the Princess in Your Editor</a></li>
    
      <li><span>06 Oct 2008</span> &raquo; <a href="/2008/10/06/the-me-meme.html">The Me Meme</a></li>
    
  </ul>
</div>

  </div>

  <div id="footer">
    <a href="http://creativecommons.org/licenses/by-sa/1.0/"><img alt="Creative Commons License" border="0" src="http://creativecommons.org/images/public/somerights" /></a> 
    Copyright &copy; 1998-2009 Michael Ivey unless otherwise stated.
    Unless otherwise noted, all content is licensed under a <a href="http://creativecommons.org/licenses/by-sa/1.0/">Creative Commons License</a>.
    <div id="generated">Page generated January  4 2009 at 10:17 PM by <a href="http://github.com/mojombo/jekyll">Jekyll</a>.</div>
  </div>


</div>
  
</body>
</html>
